<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision Shelly - BTS CIEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700&display=swap');
        body { font-family: 'Urbanist', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-amber-500">
                    Supervision Borne Shelly
                </h1>
                <p class="text-slate-400">Flux MQTT : <span class="font-mono text-amber-500/80">Shellies/#</span></p>
            </div>
            <div class="flex gap-3">
                <div id="api-status" class="glass px-4 py-2 rounded-full flex items-center gap-2 text-sm border-red-500/50">
                    <span class="w-2 h-2 rounded-full bg-red-500 status-pulse"></span>
                    Serveur: <span class="font-bold">D√©connect√©</span>
                </div>
            </div>
        </header>

        <!-- Main Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Power Card (Puissance instantan√©e) -->
            <div class="glass p-6 rounded-3xl border-t-4 border-orange-500">
                <p class="text-slate-400 text-sm uppercase tracking-wider mb-1">Puissance Instantan√©e</p>
                <div class="flex items-baseline gap-2">
                    <span id="power-val" class="text-5xl font-bold text-orange-400">0.0</span>
                    <span class="text-xl text-slate-500 font-semibold">W</span>
                </div>
                <div class="mt-4 h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div id="power-bar" class="h-full bg-orange-500 transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

            <!-- Energy Card (Consommation Cumul√©e) -->
            <div class="glass p-6 rounded-3xl border-t-4 border-blue-500">
                <p class="text-slate-400 text-sm uppercase tracking-wider mb-1">√ânergie Consomm√©e ($E=P \cdot t$)</p>
                <div class="flex items-baseline gap-2">
                    <span id="energy-val" class="text-5xl font-bold text-blue-400">0.0000</span>
                    <span class="text-xl text-slate-500 font-semibold">Wh</span>
                </div>
                <div id="last-topic" class="text-[10px] font-mono truncate text-slate-500 mt-4">En attente de donn√©es...</div>
            </div>

            <!-- Relay Status -->
            <div class="glass p-6 rounded-3xl border-t-4 border-emerald-500 flex flex-col justify-center">
                <p class="text-slate-400 text-sm uppercase tracking-wider mb-2">√âtat du Relais</p>
                <div id="relay-status" class="text-2xl font-bold text-slate-500 uppercase">Inconnu</div>
                <p id="last-time" class="text-xs text-slate-500 mt-2 italic">Aucun message re√ßu</p>
            </div>
        </div>

        <!-- Live Feed -->
        <div class="glass rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h3 class="font-bold flex items-center gap-2 text-orange-400">
                    <i data-lucide="activity" class="w-5 h-5"></i> Moniteur de bus Shellies
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-xs uppercase text-slate-500 bg-slate-900/50">
                        <tr>
                            <th class="px-6 py-3">Heure</th>
                            <th class="px-6 py-3">ID Prise</th>
                            <th class="px-6 py-3">Sujet (Topic)</th>
                            <th class="px-6 py-3">Valeur Brute</th>
                        </tr>
                    </thead>
                    <tbody id="log-table" class="divide-y divide-white/5 font-mono text-sm">
                        <!-- Rempli par Socket.io -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // Configuration
            const SOCKET_URL = "https://recharge.cielnewton.fr"; 

            // Initialisation des ic√¥nes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Connexion au serveur de ton API
            if (typeof io !== 'undefined') {
                const socket = io(SOCKET_URL, {
                    path: '/socket.io/'
                });

                socket.on('connect', () => {
                    updateStatusDisplay(true);
                    console.log("‚úÖ Li√© √† l'API via WebSocket");
                });

                socket.on('disconnect', () => {
                    updateStatusDisplay(false);
                });

                // √âcoute de l'√©v√©nement "iot_data"
                socket.on('iot_data', (data) => {
                    console.log("üì© Donn√©e re√ßue:", data);

                    const topic = data.topic.toLowerCase();
                    const val = data.value;

                    // 1. Mise √† jour de l'√ânergie (Nouveaut√© calcul√©e par ton API)
                    if (data.energy) {
                        document.getElementById('energy-val').innerText = data.energy;
                    }

                    // 2. D√©tection de la puissance
                    if (topic.includes('power')) {
                        const numVal = parseFloat(val);
                        document.getElementById('power-val').innerText = numVal.toFixed(1);
                        
                        // Calcul de la barre de progression (max arbitraire 2500W)
                        const percent = Math.min((numVal / 2500) * 100, 100);
                        document.getElementById('power-bar').style.width = percent + '%';
                    }

                    // 3. D√©tection de l'√©tat du relais (on/off)
                    if (topic.includes('relay') && !topic.includes('power')) {
                        const statusEl = document.getElementById('relay-status');
                        statusEl.innerText = val.toUpperCase();
                        statusEl.className = val === 'on' ? 'text-2xl font-bold text-emerald-400' : 'text-2xl font-bold text-rose-400';
                    }

                    // 4. Mise √† jour des textes d'information
                    document.getElementById('last-topic').innerText = `Dernier topic : ${data.topic}`;
                    document.getElementById('last-time').innerText = `Re√ßu √† ${data.time}`;

                    // 5. Ajout dans le tableau de monitoring
                    addLogRow(data);
                });
            }
        };

        function addLogRow(data) {
            const table = document.getElementById('log-table');
            const row = table.insertRow(0);
            row.className = "hover:bg-white/5 transition-colors";
            
            row.innerHTML = `
                <td class="px-6 py-3 text-slate-500">${data.time}</td>
                <td class="px-6 py-3 font-bold text-blue-400">${data.plugId}</td>
                <td class="px-6 py-3 font-semibold text-orange-300/80">${data.topic}</td>
                <td class="px-6 py-3 text-cyan-400">${data.value}</td>
            `;

            if (table.rows.length > 15) table.deleteRow(15);
        }

        function updateStatusDisplay(connected) {
            const el = document.getElementById('api-status');
            const dot = el.querySelector('span:first-child');
            const label = el.querySelector('span:last-child');
            
            if (connected) {
                el.classList.replace('border-red-500/50', 'border-emerald-500/50');
                dot.classList.replace('bg-red-500', 'bg-emerald-500');
                label.innerText = 'En ligne';
            } else {
                el.classList.replace('border-emerald-500/50', 'border-red-500/50');
                dot.classList.replace('bg-emerald-500', 'bg-red-500');
                label.innerText = 'Hors ligne';
            }
        }
    </script>
</body>
</html>